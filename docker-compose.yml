version: "3.9"

services:
  # ðŸŸ¢ MQTT Broker (Mosquitto)
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mqtt-broker
    restart: always
    ports:
      - "3500:3500"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./data:/mosquitto/data
      - ./log:/mosquitto/log
    networks:
      - sensor-net

  # ðŸŸ£ Python Publisher (Controller Simulator)
  publisher:
    build: ./publisher
    container_name: controller-sim
    restart: always
    depends_on:
      - mosquitto
    networks:
      - sensor-net
    command: ["python","publisher.py","--host","mosquitto","--port","3500","--interval","1.0"]

  # ðŸŸ  Node-RED
  nodered:
    image: nodered/node-red:3.1
    container_name: node-red
    restart: always
    depends_on:
      - mosquitto
    ports:
      - "3501:1880"
    networks:
      - sensor-net
    volumes:
      - ./nodered_data:/data

  # ðŸ”µ InfluxDB 2.x
  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    restart: always
    ports:
      - "3502:8086"
    networks:
      - sensor-net
    volumes:
      - ./influxdb-data:/var/lib/influxdb2
      - ./influxdb-config:/etc/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=Admin!234
      - DOCKER_INFLUXDB_INIT_ORG=ameel
      - DOCKER_INFLUXDB_INIT_BUCKET=controller
      - DOCKER_INFLUXDB_INIT_RETENTION=30d
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=avbpXMbJFJCmkFQmXjH9XhLqsIkGyYt9D_W3lWjtjm1q1liEfTArocaTYCzbfTeMG5mgpl29DfckYB3pFzhhbQ==

  # ðŸŸ¡ Portainer (Docker beheer UI)
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: always
    ports:
      - "5004:9443"
      - "5005:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - sensor-net

networks:
  sensor-net:
    driver: bridge

volumes:
  portainer_data:
    driver: local
